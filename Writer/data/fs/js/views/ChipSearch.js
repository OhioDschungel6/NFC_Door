import AbstractView from "./AbstractView.js";

const CASE_MAP = {
    Ok: {
        retry: false,
        error: false,
        message: "Creation succeeded!"
    },
    AlreadyRegistered: {
        retry: false,
        error: false,
        message: "Device was already registered!"
    },
    Failed: {
        retry: false,
        error: true,
        message: "Creation failed - try again!"
    },
    NoCard: {
        retry: true,
        error: true,
        message: "How did you get here???"
    },
    CardNotCompatible: {
        retry: false,
        error: false,
        message: "Card is not compatible - creation failed!"
    },
    AppNotInstalled: {
        retry: false,
        error: false,
        message: "The corresponding application is not installed on your device - creation failed!"
    },
    NfcError: {
        retry: true,
        error: false,
        message: "You won 1 million dollars, congratulations!"
    }
}

export default class extends AbstractView {
    constructor(params, functions, payload) {
        super(params);
        this.payload = payload;
        this.setTitle("Searching...");

        function poll() {
            fetch(window.location.protocol + "//" + window.location.host + "/api/chip", {method: 'POST', body: JSON.stringify({name: payload.name})})
                .then(result => result.json())
                .then(response => {
                    var caseFound = CASE_MAP[response.result]
                    if (!caseFound || caseFound.retry) {
                        throw new Error()
                    }
                    functions.navigateToPath(caseFound.error ? "/new/failure" : "/new/success", {message: caseFound.message});
                })
                .catch((error) => {
                    if (window.location.href.includes("/new/search")) {
                        setTimeout(poll, 2000);
                    }
                })
        }
        if (payload?.name) {
            poll();
        }
    }

    async getHtml() {
        return  `
            <div class="chip-search container">
                <svg width="480" height="400" viewBox="0 0 120 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g id="Frame 1">
                        <rect width="120" height="100" fill="white"/>
                        <g id="Reader">
                            <rect id="Rectangle 2" x="10.5" y="21.5" width="41" height="60" rx="4.5" fill="white" stroke="black"/>
                            <rect id="Rectangle 3" x="14.5" y="37.5" width="33" height="39" rx="1.5" fill="white" stroke="black"/>
                            <g id="Group 4">
                                <path id="Ellipse 5" d="M41.9286 57C41.9286 63.1769 37.026 68.1667 31 68.1667C24.974 68.1667 20.0714 63.1769 20.0714 57C20.0714 50.823 24.974 45.8333 31 45.8333C37.026 45.8333 41.9286 50.823 41.9286 57Z" fill="white" stroke="black"/>
                                <path id="Polygon 1" d="M28.7143 57L18.4286 69.1244V44.8756L28.7143 57Z" fill="white"/>
                                <path id="Polygon 2" d="M33.2857 57L43.5714 69.1244V44.8756L33.2857 57Z" fill="white"/>
                            </g>
                            <g id="Group 2">
                                <path id="Ellipse 5_2" d="M38.3571 57C38.3571 61.3544 35.0359 64.8333 31 64.8333C26.9641 64.8333 23.6429 61.3544 23.6429 57C23.6429 52.6456 26.9641 49.1667 31 49.1667C35.0359 49.1667 38.3571 52.6456 38.3571 57Z" fill="white" stroke="black"/>
                                <path id="Polygon 1_2" d="M31 57L22.75 63.9282V50.0718L31 57Z" fill="white"/>
                                <path id="Polygon 2_2" d="M31 57L39.25 63.9282V50.0718L31 57Z" fill="white"/>
                            </g>
                            <g id="Group 3">
                                <circle id="Ellipse 5_3" cx="31" cy="57" r="4.5" fill="white" stroke="black"/>
                                <path id="Polygon 1_3" d="M30 57L24.75 62.1962V51.8038L30 57Z" fill="white"/>
                                <path id="Polygon 2_3" d="M32 57L37.25 62.1962V51.8038L32 57Z" fill="white"/>
                            </g>
                            <circle id="Ellipse 4" cx="31" cy="57" r="0.75" fill="white" stroke="black" stroke-width="0.5"/>
                            <path id="Header" d="M17.7486 34V27.8182H19.8374C20.3203 27.8182 20.7167 27.9007 21.0266 28.0657C21.3365 28.2287 21.5659 28.4531 21.7148 28.7388C21.8638 29.0246 21.9382 29.3496 21.9382 29.7138C21.9382 30.078 21.8638 30.401 21.7148 30.6827C21.5659 30.9644 21.3375 31.1858 21.0297 31.3468C20.7218 31.5057 20.3284 31.5852 19.8494 31.5852H18.1591V30.9091H19.8253C20.1553 30.9091 20.4209 30.8608 20.6222 30.7642C20.8254 30.6676 20.9723 30.5308 21.0629 30.3537C21.1554 30.1746 21.2017 29.9613 21.2017 29.7138C21.2017 29.4663 21.1554 29.2499 21.0629 29.0648C20.9703 28.8797 20.8224 28.7368 20.6191 28.6362C20.4159 28.5336 20.1473 28.4822 19.8132 28.4822H18.4972V34H17.7486ZM20.6584 31.223L22.1797 34H21.3104L19.8132 31.223H20.6584ZM24.9831 34.0966C24.5364 34.0966 24.151 33.998 23.827 33.8008C23.505 33.6016 23.2565 33.3239 23.0815 32.9677C22.9084 32.6095 22.8219 32.1929 22.8219 31.718C22.8219 31.2431 22.9084 30.8246 23.0815 30.4624C23.2565 30.0981 23.5 29.8144 23.8119 29.6112C24.1258 29.4059 24.4921 29.3033 24.9106 29.3033C25.1521 29.3033 25.3906 29.3435 25.626 29.424C25.8615 29.5045 26.0758 29.6353 26.269 29.8164C26.4621 29.9955 26.6161 30.233 26.7308 30.5288C26.8455 30.8246 26.9028 31.1888 26.9028 31.6214V31.9233H23.329V31.3075H26.1784C26.1784 31.0459 26.1261 30.8125 26.0214 30.6072C25.9188 30.402 25.7719 30.24 25.5807 30.1213C25.3916 30.0025 25.1682 29.9432 24.9106 29.9432C24.6269 29.9432 24.3814 30.0136 24.1741 30.1545C23.9689 30.2933 23.8109 30.4744 23.7002 30.6978C23.5896 30.9212 23.5342 31.1606 23.5342 31.4162V31.8267C23.5342 32.1768 23.5946 32.4737 23.7153 32.7172C23.8381 32.9586 24.0081 33.1428 24.2255 33.2695C24.4428 33.3943 24.6953 33.4567 24.9831 33.4567C25.1702 33.4567 25.3393 33.4305 25.4902 33.3782C25.6431 33.3239 25.7749 33.2434 25.8856 33.1367C25.9963 33.0281 26.0818 32.8932 26.1422 32.7322L26.8304 32.9254C26.7579 33.1589 26.6362 33.3641 26.4652 33.5412C26.2941 33.7163 26.0828 33.8531 25.8313 33.9517C25.5797 34.0483 25.297 34.0966 24.9831 34.0966ZM29.3508 34.1087C29.057 34.1087 28.7904 34.0533 28.5509 33.9426C28.3114 33.83 28.1213 33.668 27.9804 33.4567C27.8396 33.2434 27.7691 32.9858 27.7691 32.6839C27.7691 32.4183 27.8215 32.203 27.9261 32.038C28.0307 31.871 28.1706 31.7402 28.3457 31.6456C28.5207 31.551 28.7139 31.4806 28.9252 31.4343C29.1385 31.386 29.3528 31.3478 29.5681 31.3196C29.8499 31.2834 30.0783 31.2562 30.2533 31.2381C30.4304 31.218 30.5592 31.1848 30.6397 31.1385C30.7222 31.0922 30.7634 31.0117 30.7634 30.897V30.8729C30.7634 30.575 30.682 30.3436 30.519 30.1786C30.358 30.0136 30.1135 29.9311 29.7855 29.9311C29.4454 29.9311 29.1788 30.0056 28.9856 30.1545C28.7924 30.3034 28.6566 30.4624 28.5781 30.6314L27.9019 30.3899C28.0227 30.1082 28.1837 29.8888 28.3849 29.7319C28.5881 29.5729 28.8095 29.4622 29.049 29.3999C29.2904 29.3355 29.5279 29.3033 29.7613 29.3033C29.9102 29.3033 30.0813 29.3214 30.2745 29.3576C30.4697 29.3918 30.6578 29.4632 30.8389 29.5719C31.022 29.6806 31.174 29.8446 31.2947 30.0639C31.4154 30.2833 31.4758 30.5771 31.4758 30.9453V34H30.7634V33.3722H30.7272C30.6789 33.4728 30.5984 33.5804 30.4858 33.6951C30.3731 33.8098 30.2231 33.9074 30.036 33.9879C29.8489 34.0684 29.6205 34.1087 29.3508 34.1087ZM29.4595 33.4688C29.7412 33.4688 29.9786 33.4134 30.1718 33.3027C30.367 33.1921 30.5139 33.0492 30.6125 32.8741C30.7131 32.699 30.7634 32.5149 30.7634 32.3217V31.6697C30.7333 31.706 30.6669 31.7392 30.5642 31.7694C30.4636 31.7975 30.3469 31.8227 30.2141 31.8448C30.0833 31.8649 29.9555 31.883 29.8307 31.8991C29.708 31.9132 29.6084 31.9253 29.5319 31.9354C29.3468 31.9595 29.1737 31.9988 29.0127 32.0531C28.8538 32.1054 28.725 32.1849 28.6264 32.2915C28.5298 32.3962 28.4815 32.5391 28.4815 32.7202C28.4815 32.9677 28.573 33.1548 28.7562 33.2816C28.9413 33.4064 29.1757 33.4688 29.4595 33.4688ZM34.5267 34.0966C34.1404 34.0966 33.7993 33.999 33.5035 33.8038C33.2077 33.6066 32.9762 33.3289 32.8092 32.9707C32.6422 32.6105 32.5587 32.1849 32.5587 31.6939C32.5587 31.2069 32.6422 30.7843 32.8092 30.4261C32.9762 30.0679 33.2087 29.7913 33.5065 29.5961C33.8043 29.4009 34.1484 29.3033 34.5388 29.3033C34.8406 29.3033 35.0791 29.3536 35.2542 29.4542C35.4313 29.5528 35.5661 29.6655 35.6586 29.7923C35.7532 29.917 35.8267 30.0196 35.879 30.1001H35.9394V27.8182H36.6517V34H35.9635V33.2876H35.879C35.8267 33.3722 35.7522 33.4788 35.6556 33.6076C35.559 33.7344 35.4212 33.8481 35.2421 33.9487C35.063 34.0473 34.8245 34.0966 34.5267 34.0966ZM34.6233 33.4567C34.9091 33.4567 35.1505 33.3822 35.3477 33.2333C35.545 33.0824 35.6949 32.8741 35.7975 32.6085C35.9001 32.3408 35.9514 32.032 35.9514 31.6818C35.9514 31.3357 35.9011 31.0328 35.8005 30.7733C35.6999 30.5117 35.551 30.3084 35.3538 30.1635C35.1566 30.0166 34.9131 29.9432 34.6233 29.9432C34.3215 29.9432 34.0699 30.0207 33.8687 30.1756C33.6695 30.3285 33.5196 30.5368 33.4189 30.8004C33.3203 31.062 33.271 31.3558 33.271 31.6818C33.271 32.0118 33.3213 32.3117 33.422 32.5813C33.5246 32.849 33.6755 33.0623 33.8747 33.2212C34.076 33.3782 34.3255 33.4567 34.6233 33.4567ZM39.9992 34.0966C39.5525 34.0966 39.1671 33.998 38.8431 33.8008C38.5212 33.6016 38.2726 33.3239 38.0976 32.9677C37.9245 32.6095 37.838 32.1929 37.838 31.718C37.838 31.2431 37.9245 30.8246 38.0976 30.4624C38.2726 30.0981 38.5161 29.8144 38.828 29.6112C39.142 29.4059 39.5082 29.3033 39.9268 29.3033C40.1682 29.3033 40.4067 29.3435 40.6421 29.424C40.8776 29.5045 41.0919 29.6353 41.2851 29.8164C41.4782 29.9955 41.6322 30.233 41.7469 30.5288C41.8616 30.8246 41.9189 31.1888 41.9189 31.6214V31.9233H38.3451V31.3075H41.1945C41.1945 31.0459 41.1422 30.8125 41.0376 30.6072C40.9349 30.402 40.788 30.24 40.5969 30.1213C40.4077 30.0025 40.1843 29.9432 39.9268 29.9432C39.643 29.9432 39.3975 30.0136 39.1903 30.1545C38.985 30.2933 38.827 30.4744 38.7164 30.6978C38.6057 30.9212 38.5503 31.1606 38.5503 31.4162V31.8267C38.5503 32.1768 38.6107 32.4737 38.7314 32.7172C38.8542 32.9586 39.0242 33.1428 39.2416 33.2695C39.4589 33.3943 39.7114 33.4567 39.9992 33.4567C40.1863 33.4567 40.3554 33.4305 40.5063 33.3782C40.6592 33.3239 40.791 33.2434 40.9017 33.1367C41.0124 33.0281 41.0979 32.8932 41.1583 32.7322L41.8465 32.9254C41.7741 33.1589 41.6523 33.3641 41.4813 33.5412C41.3102 33.7163 41.0989 33.8531 40.8474 33.9517C40.5959 34.0483 40.3131 34.0966 39.9992 34.0966ZM43.0026 34V29.3636H43.6908V30.0639H43.7391C43.8236 29.8345 43.9765 29.6484 44.1979 29.5055C44.4192 29.3626 44.6688 29.2912 44.9465 29.2912C44.9988 29.2912 45.0642 29.2922 45.1427 29.2942C45.2211 29.2962 45.2805 29.2992 45.3208 29.3033V30.0277C45.2966 30.0217 45.2413 30.0126 45.1547 30.0005C45.0702 29.9864 44.9807 29.9794 44.8861 29.9794C44.6607 29.9794 44.4595 30.0267 44.2824 30.1213C44.1073 30.2138 43.9685 30.3426 43.8659 30.5076C43.7652 30.6706 43.7149 30.8568 43.7149 31.0661V34H43.0026Z" fill="black"/>
                            <rect id="Rectangle 4" x="29" y="19" width="5" height="3" fill="black"/>
                            <rect id="Rectangle 5" x="31" y="14" width="1" height="6" fill="black"/>
                        </g>
                        <g id="Card" filter="">
                            <rect id="Rectangle 1" x="59.6893" y="44.703" width="32" height="52" rx="2.5" transform="rotate(-32.1189 59.6893 44.703)" fill="white" stroke="black"/>
                            <path id="NFC" d="M89.3311 37.2917L83.7875 40.7718L83.3797 40.1222L85.8359 34.3689L85.8019 34.3148L81.4493 37.0472L81.0279 36.3759L86.5715 32.8958L86.9794 33.5454L84.5191 39.3163L84.5531 39.3705L88.9165 36.6313L89.3311 37.2917ZM84.6307 42.1151L90.1744 38.635L92.2611 41.959L91.6656 42.3329L90.0003 39.6802L88.1271 40.856L89.6361 43.2597L89.0406 43.6336L87.5316 41.2299L85.0522 42.7864L84.6307 42.1151ZM94.0508 48.6572L93.6294 47.9859C93.7976 47.825 93.9236 47.649 94.0074 47.458C94.0924 47.2688 94.1404 47.0727 94.1513 46.8696C94.1651 46.6672 94.144 46.4654 94.0881 46.264C94.0321 46.0627 93.9464 45.87 93.8308 45.6859C93.6201 45.3502 93.3444 45.0994 93.0037 44.9334C92.6642 44.7692 92.2789 44.7105 91.8478 44.7572C91.4179 44.8057 90.9629 44.9806 90.4829 45.2819C90.0029 45.5832 89.6476 45.917 89.417 46.2831C89.1876 46.651 89.0731 47.0235 89.0734 47.4007C89.0748 47.7797 89.1809 48.137 89.3916 48.4727C89.5071 48.6567 89.6434 48.8177 89.8004 48.9556C89.9574 49.0935 90.1292 49.2008 90.3156 49.2775C90.5051 49.3548 90.7034 49.3963 90.9108 49.402C91.1211 49.4083 91.3343 49.3713 91.5505 49.2909L91.9719 49.9622C91.6569 50.0896 91.3456 50.1567 91.038 50.1636C90.7304 50.1706 90.4358 50.1241 90.1542 50.0241C89.8744 49.923 89.6163 49.7744 89.3799 49.5781C89.1446 49.3837 88.9392 49.1466 88.7636 48.8669C88.4668 48.3941 88.3183 47.9011 88.3182 47.388C88.3181 46.8748 88.4647 46.379 88.758 45.9006C89.0514 45.4221 89.4904 44.9993 90.0751 44.6323C90.6597 44.2652 91.2313 44.0536 91.7897 43.9974C92.3481 43.9412 92.8584 44.0246 93.3205 44.2478C93.7826 44.4709 94.162 44.8189 94.4588 45.2917C94.6344 45.5714 94.7586 45.8594 94.8315 46.1558C94.9055 46.454 94.9263 46.7517 94.8939 47.0487C94.8633 47.3446 94.778 47.6296 94.6381 47.9036C94.5 48.1765 94.3042 48.4277 94.0508 48.6572Z" fill="black"/>
                            <g id="Group 1">
                                <circle id="Ellipse 2" cx="95.0019" cy="52.0531" r="0.5" transform="rotate(57.8811 95.0019 52.0531)" fill="black"/>
                                <path id="Line 5" d="M97.0698 52.526V52.526C96.9663 53.7717 95.6959 54.5692 94.529 54.121V54.121" stroke="black" stroke-width="0.5"/>
                                <path id="Line 6" d="M99.8271 53.1565V53.1565C99.9279 56.258 96.6478 58.3171 93.8984 56.8782V56.8782" stroke="black" stroke-width="0.5"/>
                                <path id="Line 7" d="M98.4484 52.8412V52.8412C98.4527 55.0199 96.1739 56.4504 94.2137 55.4996V55.4996" stroke="black" stroke-width="0.5"/>
                            </g>
                            <line id="Line 8" x1="67.5777" y1="40.3414" x2="94.6932" y2="83.5357" stroke="black" stroke-width="3"/>
                        </g>
                    </g>
                    <defs>
                       <filter id="filter0_d_2_2" x="56.1355" y="26.1355" width="61.8572" height="68.1626" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                          <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                          <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                          <feOffset dy="2"/>
                          <feGaussianBlur stdDeviation="2"/>
                          <feComposite in2="hardAlpha" operator="out"/>
                          <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
                          <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2_2"/>
                          <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2_2" result="shape"/>
                       </filter>
                    </defs>
                </svg>
         
         
            
                <h2>
                    Place your NFC-Device onto the chip-reader now...
                </h2>
            </div>
        `;
    }

    onCreated(params, functions, payload) {
        if (!payload?.name) {
            functions.navigateToPath("/new");
        }
    }
}